<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <title>AR äº’å‹•é«”é©—</title>
        <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
        <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
        <style>
            /* --- åŸæœ‰æ¨£å¼ä¿æŒä¸è®Š --- */
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; background: #000; }

            /* 1. ç¬¬ä¸€å±¤ï¼šæ­¡è¿é é¢ */
            #welcome-screen {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: linear-gradient(180deg, #1a1a1a 0%, #000000 100%);
                display: flex; flex-direction: column; justify-content: center; align-items: center;
                z-index: 1000; color: white; text-align: center; padding: 40px 30px;
                transition: opacity 0.5s ease, transform 0.5s ease;
            }

            #welcome-screen.hidden {
                opacity: 0;
                transform: scale(1.1);
                pointer-events: none;
            }

            /* 2. ç¬¬äºŒå±¤ï¼šä¸‰å€‹æŒ‰éˆ•çš„é¸å–®ä»‹é¢ */
            #menu-screen {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8);
                display: none; /* é è¨­éš±è— */
                flex-direction: column; justify-content: flex-end; align-items: center;
                z-index: 900; padding-bottom: 50px; transition: all 0.5s ease;
            }

            #menu-screen.active {
                display: flex;
            }

            .btn-group { 
                display: flex; 
                flex-direction: column; 
                gap: 15px; 
                width: 80%; 
                max-width: 400px;
            }

            /* --- é—œéµä¿®æ­£ï¼šAR å ´æ™¯æ¨£å¼ --- */
            #scene-container {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 1;
                /* ä½¿ç”¨ visibility è€Œé display:none é¿å…ç›¸æ©Ÿè¡Œç¨‹è¢«æ®ºæ‰ */
                visibility: hidden; 
                pointer-events: none; /* åŠ ä¸Šé€™è¡Œï¼Œé˜²æ­¢æ“‹ä½æ­¡è¿é é»æ“Š */
            }

            #scene-container.active {
                visibility: visible;
                pointer-events: auto; /* é–‹å•Ÿæ™‚æ¢å¾©é»æ“Š */
            }

            /* --- å…¶ä»– UI æ¨£å¼ --- */
            .btn { padding: 18px 60px; background: rgba(255, 255, 255, 0.15); color: white; border-radius: 50px; cursor: pointer; border: 1px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(20px); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
            .btn:hover { background: rgba(255, 255, 255, 0.25); transform: translateY(-2px); }
            .btn:active { transform: scale(0.97); }
            
            #control-panel { position: fixed; bottom: 0; left: 0; right: 0; z-index: 100; display: none; padding: 20px; backdrop-filter: blur(20px); background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 70%, transparent 100%); padding-bottom: max(20px, env(safe-area-inset-bottom)); }
            #control-panel.active { display: block; }
            
            #ar-back-button { position: fixed; top: max(env(safe-area-inset-top), 20px); right: 20px; width: 44px; height: 44px; border-radius: 50%; background: rgba(255, 255, 255, 0.15); display: none; align-items: center; justify-content: center; z-index: 1500; cursor: pointer; border: 1px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(20px); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: white; font-size: 1.5rem; }
            #ar-back-button.active { display: flex; }
            #ar-back-button:hover { background: rgba(255, 255, 255, 0.25); transform: scale(1.05); }
            #ar-back-button:active { transform: scale(0.95); }
            
            #camera-btn { position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); width: 72px; height: 72px; border-radius: 50%; background: white; display: none; z-index: 1500; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 8px 32px rgba(0,0,0,0.4); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
            #camera-btn.active { display: flex; }
            #camera-btn:active { transform: translateX(-50%) scale(0.85); }
            #camera-btn::before { content: 'ğŸ“·'; font-size: 2rem; }
            
            /* æ‹ç…§å€’è®¡æ—¶ */
            #camera-countdown {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 8rem;
                font-weight: 700;
                color: white;
                z-index: 200;
                pointer-events: none;
                display: none;
                text-shadow: 0 4px 20px rgba(0,0,0,0.5);
                animation: countdownPop 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            }

            @keyframes countdownPop {
                0% {
                    opacity: 0;
                    transform: translate(-50%, -50%) scale(0.5);
                }
                50% {
                    opacity: 1;
                    transform: translate(-50%, -50%) scale(1.1);
                }
                100% {
                    opacity: 0;
                    transform: translate(-50%, -50%) scale(0.8);
                }
            }

            #camera-countdown.active {
                display: block;
            }

            /* æ‹ç…§é—ªå…‰æ•ˆæœ */
            #camera-flash {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: white;
                z-index: 199;
                opacity: 0;
                pointer-events: none;
                display: none;
            }

            #camera-flash.active {
                display: block;
                animation: flash 0.3s ease;
            }

            @keyframes flash {
                0%, 100% {
                    opacity: 0;
                }
                50% {
                    opacity: 0.8;
                }
            }
            
            /* æ‹ç…§é è¦½ */
            #photo-preview { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 300; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
            #photo-preview.active { display: flex; }
            #photo-preview img { width: 100%; max-width: 500px; height: auto; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
            #photo-preview .preview-controls { margin-top: 40px; display: flex; gap: 15px; width: 100%; max-width: 500px; justify-content: center; }
            .preview-btn { padding: 16px 40px; border: none; border-radius: 50px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); min-height: 56px; flex: 1; max-width: 200px; }
            .preview-btn.save { background: rgba(52, 199, 89, 0.2); color: #34C759; border: 1px solid rgba(52, 199, 89, 0.3); }
            .preview-btn.close { background: rgba(255, 59, 48, 0.2); color: #FF3B30; border: 1px solid rgba(255, 59, 48, 0.3); }
            .preview-btn:active { transform: scale(0.97); }

            /* ä¿å­˜æç¤º */
            #save-toast {
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(20px);
                color: white;
                padding: 16px 32px;
                border-radius: 50px;
                font-size: 1rem;
                font-weight: 500;
                z-index: 400;
                opacity: 0;
                pointer-events: none;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                display: flex;
                align-items: center;
                gap: 10px;
            }

            #save-toast.active {
                opacity: 1;
                animation: toastSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) both;
            }

            @keyframes toastSlideUp {
                from {
                    opacity: 0;
                    transform: translateX(-50%) translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateX(-50%) translateY(0);
                }
            }
        </style>
    </head>

    <body>
        <!-- 1. ç¬¬ä¸€å±¤ï¼šæ­¡è¿é é¢ -->
        <div id="welcome-screen">
            <div class="content-wrapper">
                <h1>AR äº’å‹•é«”é©—</h1>
                <p style="margin-bottom: 50px; color: rgba(255,255,255,0.7);">æ¢ç´¢æ“´å¢å¯¦å¢ƒçš„ç„¡é™å¯èƒ½</p>
                <button class="btn" onclick="goToMenu()"><span>é–‹å§‹é«”é©—</span></button>
            </div>
        </div>

        <!-- 2. ç¬¬äºŒå±¤ï¼šé¸å–®ä»‹é¢ -->
        <div id="menu-screen">
            <div class="btn-group">
                <button class="btn" onclick="enterAR('type1')">ä»‹ç´¹æŒ‰éˆ• 1</button>
                <button class="btn" onclick="enterAR('type2')">ä»‹ç´¹æŒ‰éˆ• 2</button>
                <button class="btn" onclick="enterAR('type3')">ä»‹ç´¹æŒ‰éˆ• 3</button>
                <button class="btn" style="background: transparent;" onclick="backToWelcome()">è¿”å›ä¸»é </button>
            </div>
        </div>

        <div id="ar-back-button" onclick="backToMenuFromAR()">âœ•</div>

        <div id="control-panel">
            <button class="btn" style="width: 100%;" onclick="toggleCamera()">ğŸ“¸ æ‹ç…§æ¨¡å¼</button>
        </div>

        <div id="camera-btn" onclick="takePhoto()"></div>

        <!-- æ‹ç…§å€’è¨ˆæ™‚ -->
        <div id="camera-countdown"></div>

        <!-- æ‹ç…§é–ƒå…‰æ•ˆæœ -->
        <div id="camera-flash"></div>

        <!-- æ‹ç…§é è¦½ -->
        <div id="photo-preview">
            <div class="preview-container">
                <img id="captured-photo" src="" alt="æ‹æ”çš„ç…§ç‰‡">
                <div class="preview-controls">
                    <button class="preview-btn save" onclick="savePhoto()">
                        <span>å„²å­˜ç…§ç‰‡</span>
                    </button>
                    <button class="preview-btn close" onclick="closePreview()">
                        <span>é—œé–‰</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ä¿å­˜æç¤º -->
        <div id="save-toast">
            <span>âœ“</span>
            <span>ç…§ç‰‡å·²å„²å­˜</span>
        </div>

        <div id="scene-container">
            <a-scene
                vr-mode-ui="enabled: false;"
                loading-screen="enabled: false;"
                renderer="logarithmicDepthBuffer: true; preserveDrawingBuffer: true;"
                embedded
                gesture-detector
                arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
            >
                <a-assets>
                    <a-asset-item id="animated-asset" src="assets/asset.glb"></a-asset-item>
                </a-assets>

                <a-marker id="animated-marker" type="pattern" preset="custom" url="assets/marker.patt">
                    <a-entity id="bowser-model" gltf-model="#animated-asset" scale="0.07 0.07 0.07" gesture-handler></a-entity>
                </a-marker>
                <a-entity camera></a-entity>
            </a-scene>
        </div>

        <script>
            let cameraMode = false;
            let capturedPhoto = null;
            let isCapturing = false;
            let currentARType = null;

            const welcome = document.getElementById('welcome-screen');
            const menu = document.getElementById('menu-screen');
            const sceneContainer = document.getElementById('scene-container');
            const backBtn = document.getElementById('ar-back-button');
            const cameraBtn = document.getElementById('camera-btn');
            const controls = document.getElementById('control-panel');

            // å¾æ­¡è¿é é€²å…¥é¸å–®
            function goToMenu() {
                welcome.classList.add('hidden');
                setTimeout(() => {
                    welcome.style.display = 'none';
                    menu.classList.add('active');
                }, 500);
            }

            // å¾é¸å–®è¿”å›æ­¡è¿é 
            function backToWelcome() {
                menu.classList.remove('active');
                welcome.style.display = 'flex';
                setTimeout(() => {
                    welcome.classList.remove('hidden');
                }, 10);
            }

            // å¾é¸å–®é»æ“ŠæŒ‰éˆ•å¾Œã€Œé€²å…¥ ARã€
            function enterAR(type) {
                console.log("æ­£åœ¨åŠ è¼‰é¡å‹:", type);
                currentARType = type;
                menu.classList.remove('active');
                
                // é¡¯ç¤º AR å®¹å™¨ (ä½¿ç”¨ visibility)
                sceneContainer.classList.add('active');
                
                // ç¢ºä¿ A-Frame çŸ¥é“è¦–çª—å¤§å°å¯èƒ½æ”¹è®Šäº†
                const scene = document.querySelector('a-scene');
                if (scene) scene.resize();
                
                // é¡¯ç¤º AR å°ˆå±¬ UI
                setTimeout(() => {
                    backBtn.classList.add('active');
                    controls.classList.add('active');
                }, 300);
            }

            // é—œéµä¿®æ­£ï¼šå¾ AR è¿”å›ã€Œé¸å–®é é¢ã€
            function backToMenuFromAR() {
                // 1. éš±è— AR UI
                backBtn.classList.remove('active');
                controls.classList.remove('active');
                cameraBtn.classList.remove('active');
                cameraMode = false;
                
                // 2. éš±è— AR å ´æ™¯ (ä½†ä¸æ®ºæ­»å®ƒ)
                sceneContainer.classList.remove('active');
                
                // 3. é¡¯ç¤ºé¸å–®é é¢
                menu.classList.add('active');
            }

            function toggleCamera() {
                cameraMode = !cameraMode;
                document.getElementById('camera-btn').classList.toggle('active', cameraMode);
            }

            // æ‹ç…§åŠŸèƒ½ï¼ˆå¸¶å€’è¨ˆæ™‚å’Œé–ƒå…‰æ•ˆæœï¼‰
            async function takePhoto() {
                if (isCapturing) return;
                
                isCapturing = true;
                const cameraBtn = document.getElementById('camera-btn');
                const countdown = document.getElementById('camera-countdown');
                const flash = document.getElementById('camera-flash');
                
                // ç¦ç”¨æ‹ç…§æŒ‰éˆ•
                cameraBtn.style.pointerEvents = 'none';
                cameraBtn.style.opacity = '0.5';
                
                // å€’è¨ˆæ™‚å‹•ç•«
                const countdownNumbers = [3, 2, 1];
                for (let i = 0; i < countdownNumbers.length; i++) {
                    countdown.textContent = countdownNumbers[i];
                    countdown.classList.add('active');
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    countdown.classList.remove('active');
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // é–ƒå…‰æ•ˆæœ
                flash.classList.add('active');
                setTimeout(() => {
                    flash.classList.remove('active');
                }, 300);
                
                // æ•ç²ç•«é¢
                setTimeout(() => {
                    capturePhoto();
                }, 100);
            }

            // æ•ç²ç…§ç‰‡ï¼ˆå¤šå±¤ç•«å¸ƒåˆæˆé‚è¼¯ï¼‰
            function capturePhoto() {
                const scene = document.querySelector('a-scene');
                const canvas = scene.canvas;
                
                if (!canvas) {
                    console.error('ç„¡æ³•æ‰¾åˆ°canvas');
                    isCapturing = false;
                    resetCameraButton();
                    return;
                }
                
                // ç²å–ç›¸æ©Ÿè¦–é »å…ƒç´ ï¼ˆARèƒŒæ™¯ï¼‰
                const video = document.querySelector('video');
                
                // å‰µå»ºåˆæˆ Canvas
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                const ctx = tempCanvas.getContext('2d');
                
                // è¨­ç½®é«˜è³ªé‡æ¸²æŸ“
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                
                try {
                    // Step 1: ç¹ªè£½ç›¸æ©Ÿè¦–é »ï¼ˆARèƒŒæ™¯ï¼‰åˆ° canvas
                    if (video && video.readyState >= 2) {
                        ctx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
                    } else {
                        // å¦‚æœè¦–é »æœªå°±ç·’ï¼Œä½¿ç”¨é»‘è‰²èƒŒæ™¯
                        ctx.fillStyle = '#000000';
                        ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                    }
                    
                    // Step 2: å°‡ A-Frame çš„ canvasï¼ˆ3Dç‰©ä»¶ï¼‰ç–ŠåŠ ç¹ªå…¥
                    ctx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
                    
                    // Step 3: è¼¸å‡ºè™•ç† - ä½¿ç”¨ canvas.toBlob() ç”Ÿæˆ PNG
                    tempCanvas.toBlob((blob) => {
                        if (blob) {
                            const url = URL.createObjectURL(blob);
                            capturedPhoto = url;
                            
                            // é¡¯ç¤ºé è¦½ï¼ˆå¸¶å‹•ç•«ï¼‰
                            showPreview(url);
                        } else {
                            console.error('ç„¡æ³•å‰µå»ºåœ–ç‰‡blob');
                        }
                        
                        isCapturing = false;
                        resetCameraButton();
                    }, 'image/png', 1.0);
                } catch (error) {
                    console.error('æ‹ç…§å¤±æ•—:', error);
                    isCapturing = false;
                    resetCameraButton();
                }
            }

            // é‡ç½®æ‹ç…§æŒ‰éˆ•
            function resetCameraButton() {
                const cameraBtn = document.getElementById('camera-btn');
                cameraBtn.style.pointerEvents = '';
                cameraBtn.style.opacity = '1';
            }

            // é¡¯ç¤ºé è¦½
            function showPreview(imageUrl) {
                const preview = document.getElementById('photo-preview');
                const img = document.getElementById('captured-photo');
                
                // é åŠ è¼‰åœ–ç‰‡
                img.onload = () => {
                    preview.classList.add('active');
                };
                
                img.src = imageUrl;
            }

            // å„²å­˜ç…§ç‰‡
            function savePhoto() {
                if (!capturedPhoto) return;
                
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                link.download = `AR_Photo_${timestamp}.png`;
                link.href = capturedPhoto;
                
                // è§¸ç™¼ä¸‹è¼‰
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // é¡¯ç¤ºä¿å­˜æç¤º
                showSaveToast();
                
                // å»¶é²é—œé–‰é è¦½ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°æç¤º
                setTimeout(() => {
                    closePreview();
                }, 1500);
            }

            // é¡¯ç¤ºä¿å­˜æç¤º
            function showSaveToast() {
                const toast = document.getElementById('save-toast');
                toast.classList.add('active');
                
                setTimeout(() => {
                    toast.classList.remove('active');
                }, 2000);
            }

            // é—œé–‰é è¦½
            function closePreview() {
                const preview = document.getElementById('photo-preview');
                preview.classList.remove('active');
                
                // æ¸…ç†è³‡æº
                if (capturedPhoto) {
                    URL.revokeObjectURL(capturedPhoto);
                    capturedPhoto = null;
                }
            }
        </script>
    </body>
</html>