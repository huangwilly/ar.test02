<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <title>AR äº’å‹•é«”é©—</title>
        <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
        <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                margin: 0;
                overflow: hidden;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }

            /* å°è¦½ç•Œé¢ - æ‰‹æ©Ÿå„ªåŒ– */
            #welcome-screen {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                color: white;
                text-align: center;
                padding: 20px;
                transition: opacity 0.5s ease;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            #welcome-screen.hidden {
                opacity: 0;
                pointer-events: none;
            }

            #welcome-screen h1 {
                font-size: 2em;
                margin-bottom: 15px;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            }

            #welcome-screen p {
                font-size: 1em;
                margin-bottom: 25px;
                max-width: 100%;
                line-height: 1.6;
                padding: 0 10px;
            }

            #welcome-screen .features {
                display: flex;
                flex-direction: column;
                gap: 15px;
                margin: 30px 0;
                width: 100%;
                max-width: 400px;
                padding: 0 10px;
            }

            #welcome-screen .feature {
                background: rgba(255,255,255,0.15);
                padding: 20px;
                border-radius: 15px;
                backdrop-filter: blur(10px);
                width: 100%;
            }

            #welcome-screen .feature h3 {
                font-size: 1.1em;
                margin-bottom: 8px;
            }

            #welcome-screen .feature p {
                font-size: 0.9em;
                margin: 0;
            }

            #welcome-screen .feature-icon {
                font-size: 2em;
                margin-bottom: 10px;
            }

            .btn {
                padding: 18px 50px;
                font-size: 1.1em;
                background: white;
                color: #667eea;
                border: none;
                border-radius: 50px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.2s ease;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                min-height: 50px;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }

            .btn:active {
                transform: scale(0.95);
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            }

            /* æ§åˆ¶é¢æ¿ - æ‰‹æ©Ÿåº•éƒ¨ */
            #control-panel {
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 100;
                display: none;
                flex-direction: row;
                gap: 10px;
                width: calc(100% - 40px);
                max-width: 400px;
                justify-content: center;
            }

            #control-panel.active {
                display: flex;
            }

            .panel-btn {
                background: rgba(255,255,255,0.95);
                border: none;
                padding: 15px;
                border-radius: 30px;
                cursor: pointer;
                font-size: 1em;
                font-weight: bold;
                color: #333;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                min-height: 50px;
                min-width: 50px;
                flex: 1;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }

            .panel-btn .btn-text {
                display: none;
            }

            @media (min-width: 400px) {
                .panel-btn {
                    padding: 15px 25px;
                }
                .panel-btn .btn-text {
                    display: inline;
                }
            }

            .panel-btn:active {
                transform: scale(0.95);
                background: white;
            }

            .panel-btn.active {
                background: #667eea;
                color: white;
            }

            /* é¸æ“‡å™¨é¢æ¿ - æ‰‹æ©Ÿå…¨å±åº•éƒ¨æŠ½å±œ */
            #selector-panel {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-radius: 20px 20px 0 0;
                padding: 25px 20px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
                display: none;
                z-index: 99;
                -webkit-overflow-scrolling: touch;
                transform: translateY(100%);
                transition: transform 0.3s ease;
            }

            #selector-panel.active {
                display: block;
                transform: translateY(0);
            }

            #selector-panel::before {
                content: '';
                display: block;
                width: 40px;
                height: 4px;
                background: #ddd;
                border-radius: 2px;
                margin: 0 auto 20px;
            }

            #selector-panel h3 {
                margin-bottom: 20px;
                color: #333;
                font-size: 1.3em;
                text-align: center;
            }

            .selector-group {
                margin-bottom: 25px;
            }

            .selector-group label {
                display: block;
                margin-bottom: 12px;
                color: #666;
                font-weight: bold;
                font-size: 1em;
            }

            .selector-item {
                background: #f5f5f5;
                padding: 18px;
                margin: 8px 0;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
                border: 2px solid transparent;
                font-size: 1em;
                min-height: 50px;
                display: flex;
                align-items: center;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }

            .selector-item:active {
                transform: scale(0.98);
                background: #e8e8e8;
            }

            .selector-item.selected {
                background: #667eea;
                color: white;
                border-color: #764ba2;
            }

            /* æ‹ç…§æŒ‰éˆ• - æ‰‹æ©Ÿå„ªåŒ– */
            #camera-btn {
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                width: 80px;
                height: 80px;
                border-radius: 50%;
                background: white;
                border: 6px solid #667eea;
                cursor: pointer;
                display: none;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 100;
                transition: all 0.2s ease;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }

            #camera-btn.active {
                display: flex;
            }

            #camera-btn:active {
                transform: translateX(-50%) scale(0.9);
            }

            #camera-btn::before {
                content: 'ğŸ“·';
                font-size: 2.5em;
            }

            /* æ‹ç…§é è¦½ - æ‰‹æ©Ÿå„ªåŒ– */
            #photo-preview {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.95);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 200;
                flex-direction: column;
                padding: 20px;
            }

            #photo-preview.active {
                display: flex;
            }

            #photo-preview img {
                max-width: 100%;
                max-height: 70vh;
                border-radius: 10px;
                box-shadow: 0 4px 30px rgba(255,255,255,0.3);
            }

            #photo-preview .preview-controls {
                margin-top: 30px;
                display: flex;
                gap: 15px;
                width: 100%;
                max-width: 400px;
                justify-content: center;
            }

            .preview-btn {
                padding: 16px 35px;
                border: none;
                border-radius: 30px;
                cursor: pointer;
                font-size: 1.1em;
                font-weight: bold;
                transition: all 0.2s ease;
                min-height: 50px;
                flex: 1;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }

            .preview-btn.save {
                background: #4CAF50;
                color: white;
            }

            .preview-btn.close {
                background: #f44336;
                color: white;
            }

            .preview-btn:active {
                transform: scale(0.95);
            }

            /* éš±è—ARå ´æ™¯ç›´åˆ°å°è¦½çµæŸ */
            #scene {
                display: none;
            }

            #scene.active {
                display: block;
            }

            /* å¹³æ¿å’Œæ¡Œé¢é©é… */
            @media (min-width: 768px) {
                #welcome-screen h1 {
                    font-size: 3em;
                }

                #welcome-screen p {
                    font-size: 1.2em;
                }

                #welcome-screen .features {
                    flex-direction: row;
                    max-width: 800px;
                }

                #welcome-screen .feature {
                    min-width: 200px;
                }

                #control-panel {
                    top: 20px;
                    right: 20px;
                    left: auto;
                    transform: none;
                    flex-direction: column;
                    width: auto;
                    max-width: none;
                }

                #selector-panel {
                    top: 80px;
                    right: 20px;
                    left: auto;
                    bottom: auto;
                    max-width: 350px;
                    max-height: 70vh;
                    border-radius: 15px;
                    transform: none;
                }

                #selector-panel::before {
                    display: none;
                }

                #camera-btn {
                    bottom: 30px;
                    width: 70px;
                    height: 70px;
                }
            }

            /* é˜²æ­¢iOS Safariåº•éƒ¨å®‰å…¨å€åŸŸé®æ“‹ */
            @supports (padding: max(0px)) {
                #control-panel {
                    bottom: max(20px, env(safe-area-inset-bottom));
                }

                #camera-btn {
                    bottom: max(100px, calc(env(safe-area-inset-bottom) + 100px));
                }

                #selector-panel {
                    padding-bottom: max(25px, env(safe-area-inset-bottom));
                }
            }
        </style>
    </head>

    <body>
        <!-- å°è¦½æ­¡è¿ç•Œé¢ -->
        <div id="welcome-screen">
            <h1>ğŸ¯ AR äº’å‹•é«”é©—</h1>
            <p>æ­¡è¿ä¾†åˆ°æ“´å¢å¯¦å¢ƒé«”é©—å¹³å°ï¼åœ¨é€™è£¡æ‚¨å¯ä»¥é¸æ“‡ä¸åŒçš„3Dç‰©ä»¶å’Œæ¨™è¨˜ï¼Œä¸¦èˆ‡å®ƒå€‘äº’å‹•æ‹ç…§ã€‚</p>
            
            <div class="features">
                <div class="feature">
                    <div class="feature-icon">ğŸ¨</div>
                    <h3>å¤šæ¨£3Dç‰©ä»¶</h3>
                    <p>é¸æ“‡æ‚¨å–œæ­¡çš„3Dæ¨¡å‹</p>
                </div>
                <div class="feature">
                    <div class="feature-icon">ğŸ“</div>
                    <h3>æ¨™è¨˜é¸æ“‡</h3>
                    <p>ä½¿ç”¨ä¸åŒçš„ARæ¨™è¨˜</p>
                </div>
                <div class="feature">
                    <div class="feature-icon">ğŸ“¸</div>
                    <h3>æ‹ç…§åŠŸèƒ½</h3>
                    <p>æ•æ‰ç²¾å½©äº’å‹•ç¬é–“</p>
                </div>
            </div>

            <button class="btn" onclick="startAR()">é–‹å§‹é«”é©—</button>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div id="control-panel">
            <button class="panel-btn" id="selector-toggle" onclick="toggleSelector()">
                <span>ğŸ¨</span> <span class="btn-text">é¸æ“‡ç‰©ä»¶</span>
            </button>
            <button class="panel-btn" id="camera-toggle" onclick="toggleCamera()">
                <span>ğŸ“¸</span> <span class="btn-text">æ‹ç…§</span>
            </button>
        </div>

        <!-- é¸æ“‡å™¨é¢æ¿ -->
        <div id="selector-panel">
            <h3>é¸æ“‡è¨­å®š</h3>
            
            <div class="selector-group">
                <label>3D ç‰©ä»¶</label>
                <div class="selector-item selected" data-type="model" data-value="asset.glb" onclick="selectItem(this, 'model')">
                    é è¨­æ¨¡å‹
                </div>
                <!-- æœªä¾†å¯ä»¥æ–°å¢æ›´å¤šç‰©ä»¶ -->
                <div class="selector-item" data-type="model" data-value="placeholder.glb" onclick="selectItem(this, 'model')" style="opacity: 0.5;">
                    ç‰©ä»¶ 2 (å³å°‡æ¨å‡º)
                </div>
            </div>

            <div class="selector-group">
                <label>AR æ¨™è¨˜</label>
                <div class="selector-item selected" data-type="marker" data-value="marker.patt" onclick="selectItem(this, 'marker')">
                    é è¨­æ¨™è¨˜
                </div>
                <!-- æœªä¾†å¯ä»¥æ–°å¢æ›´å¤šæ¨™è¨˜ -->
                <div class="selector-item" data-type="marker" data-value="placeholder.patt" onclick="selectItem(this, 'marker')" style="opacity: 0.5;">
                    æ¨™è¨˜ 2 (å³å°‡æ¨å‡º)
                </div>
            </div>
        </div>

        <!-- æ‹ç…§æŒ‰éˆ• -->
        <div id="camera-btn" onclick="takePhoto()"></div>

        <!-- æ‹ç…§é è¦½ -->
        <div id="photo-preview">
            <img id="captured-photo" src="" alt="æ‹æ”çš„ç…§ç‰‡">
            <div class="preview-controls">
                <button class="preview-btn save" onclick="savePhoto()">å„²å­˜ç…§ç‰‡</button>
                <button class="preview-btn close" onclick="closePreview()">é—œé–‰</button>
            </div>
        </div>

        <!-- AR å ´æ™¯ -->
        <a-scene
            vr-mode-ui="enabled: false;"
            loading-screen="enabled: false;"
            renderer="logarithmicDepthBuffer: true;"
            arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
            id="scene"
            embedded
            gesture-detector
        >
            <a-assets>
                <a-asset-item
                    id="animated-asset"
                    src="assets/asset.glb"
                ></a-asset-item>
            </a-assets>

            <a-marker
                id="animated-marker"
                type="pattern"
                preset="custom"
                url="assets/marker.patt"
                raycaster="objects: .clickable"
                emitevents="true"
                cursor="fuse: false; rayOrigin: mouse;"
            >
                <a-entity
                    id="bowser-model"
                    scale="0.07102171845054175 0.07102171845054175 0.07102171845054175"
                    animation-mixer="loop: repeat"
                    gltf-model="#animated-asset"
                    class="clickable"
                    gesture-handler
                ></a-entity>
            </a-marker>

            <a-entity camera></a-entity>
        </a-scene>

        <script>
            let currentModel = 'asset.glb';
            let currentMarker = 'marker.patt';
            let cameraMode = false;
            let capturedPhoto = null;

            // é–‹å§‹ARé«”é©—
            function startAR() {
                const welcomeScreen = document.getElementById('welcome-screen');
                const scene = document.getElementById('scene');
                const controlPanel = document.getElementById('control-panel');
                
                welcomeScreen.classList.add('hidden');
                setTimeout(() => {
                    welcomeScreen.style.display = 'none';
                    scene.classList.add('active');
                    controlPanel.classList.add('active');
                }, 500);
            }

            // åˆ‡æ›é¸æ“‡å™¨é¢æ¿
            function toggleSelector() {
                const panel = document.getElementById('selector-panel');
                const btn = document.getElementById('selector-toggle');
                
                if (panel.classList.contains('active')) {
                    panel.classList.remove('active');
                    btn.classList.remove('active');
                } else {
                    panel.classList.add('active');
                    btn.classList.add('active');
                }
            }

            // åˆ‡æ›æ‹ç…§æ¨¡å¼
            function toggleCamera() {
                cameraMode = !cameraMode;
                const cameraBtn = document.getElementById('camera-btn');
                const toggleBtn = document.getElementById('camera-toggle');
                
                if (cameraMode) {
                    cameraBtn.classList.add('active');
                    toggleBtn.classList.add('active');
                } else {
                    cameraBtn.classList.remove('active');
                    toggleBtn.classList.remove('active');
                }
            }

            // é¸æ“‡ç‰©ä»¶æˆ–æ¨™è¨˜
            function selectItem(element, type) {
                // ç§»é™¤åŒé¡å‹é …ç›®çš„é¸ä¸­ç‹€æ…‹
                const items = document.querySelectorAll(`.selector-item[data-type="${type}"]`);
                items.forEach(item => item.classList.remove('selected'));
                
                // é¸ä¸­ç•¶å‰é …ç›®
                element.classList.add('selected');
                
                const value = element.getAttribute('data-value');
                
                if (type === 'model') {
                    currentModel = value;
                    updateModel(value);
                } else if (type === 'marker') {
                    currentMarker = value;
                    updateMarker(value);
                }
            }

            // æ›´æ–°3Dæ¨¡å‹
            function updateModel(modelPath) {
                const modelEntity = document.getElementById('bowser-model');
                if (modelPath === 'asset.glb') {
                    // æ›´æ–°ç¾æœ‰æ¨¡å‹
                    modelEntity.setAttribute('gltf-model', '#animated-asset');
                } else {
                    // æœªä¾†å¯ä»¥å‹•æ…‹è¼‰å…¥æ–°æ¨¡å‹
                    console.log('è¼‰å…¥æ–°æ¨¡å‹:', modelPath);
                    // é€™è£¡å¯ä»¥æ·»åŠ å‹•æ…‹è¼‰å…¥é‚è¼¯
                }
            }

            // æ›´æ–°æ¨™è¨˜
            function updateMarker(markerPath) {
                const marker = document.getElementById('animated-marker');
                if (markerPath === 'marker.patt') {
                    marker.setAttribute('url', 'assets/marker.patt');
                } else {
                    // æœªä¾†å¯ä»¥å‹•æ…‹è¼‰å…¥æ–°æ¨™è¨˜
                    console.log('è¼‰å…¥æ–°æ¨™è¨˜:', markerPath);
                    // é€™è£¡å¯ä»¥æ·»åŠ å‹•æ…‹è¼‰å…¥é‚è¼¯
                }
            }

            // æ‹ç…§åŠŸèƒ½
            function takePhoto() {
                const scene = document.getElementById('scene');
                const canvas = scene.canvas;
                
                // å‰µå»ºè‡¨æ™‚canvasä¾†æ•ç²ç•«é¢
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                const ctx = tempCanvas.getContext('2d');
                
                // ç¹ªè£½ARå ´æ™¯åˆ°canvas
                ctx.drawImage(canvas, 0, 0);
                
                // è½‰æ›ç‚ºåœ–ç‰‡
                tempCanvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    capturedPhoto = url;
                    
                    // é¡¯ç¤ºé è¦½
                    const preview = document.getElementById('photo-preview');
                    const img = document.getElementById('captured-photo');
                    img.src = url;
                    preview.classList.add('active');
                }, 'image/png');
            }

            // å„²å­˜ç…§ç‰‡
            function savePhoto() {
                if (!capturedPhoto) return;
                
                const link = document.createElement('a');
                link.download = `AR_Photo_${new Date().getTime()}.png`;
                link.href = capturedPhoto;
                link.click();
                
                closePreview();
            }

            // é—œé–‰é è¦½
            function closePreview() {
                const preview = document.getElementById('photo-preview');
                preview.classList.remove('active');
                
                if (capturedPhoto) {
                    URL.revokeObjectURL(capturedPhoto);
                    capturedPhoto = null;
                }
            }

            // é»æ“Šå¤–éƒ¨é—œé–‰é¸æ“‡å™¨
            document.addEventListener('click', (e) => {
                const selectorPanel = document.getElementById('selector-panel');
                const selectorToggle = document.getElementById('selector-toggle');
                
                if (selectorPanel.classList.contains('active') && 
                    !selectorPanel.contains(e.target) && 
                    !selectorToggle.contains(e.target)) {
                    selectorPanel.classList.remove('active');
                    selectorToggle.classList.remove('active');
                }
            });

            // æ‰‹æ©Ÿç«¯å„ªåŒ–ï¼šé˜²æ­¢é¸æ“‡å™¨é¢æ¿èƒŒæ™¯æ»¾å‹•
            let selectorPanel = document.getElementById('selector-panel');
            selectorPanel.addEventListener('touchmove', (e) => {
                if (e.target === selectorPanel || selectorPanel.contains(e.target)) {
                    e.stopPropagation();
                }
            }, { passive: false });

            // é˜²æ­¢é›™æ“Šç¸®æ”¾
            let lastTouchEnd = 0;
            document.addEventListener('touchend', (e) => {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        </script>
    </body>
</html>
